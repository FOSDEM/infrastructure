---
- name: create the sreview configuration directory
  file:
    name: /etc/sreview
    state: directory

- name: ensure that sreview is configured
  template:
    dest: /etc/sreview/config.pm
    src: config.j2
    owner: root
    group: root
    mode: 0664
  register: sreview_config_fix
  notify:
    - restart sreview-web
    - restart sreview-dispatch

- name: install required packages
  apt:
    state: latest
    install_recommends: false
    package:
    - rsync
    - gnupg
    - libnet-ssh2-perl

- name: ensure the SSH key directory exists
  file:
    name: /var/lib/sreview/.ssh
    state: directory
    owner: sreview
    group: sreview
  when: "'cloud-encoders' in group_names"

- name: generate an SSH key for SReview
  community.crypto.openssh_keypair:
    path: /var/lib/sreview/.ssh/id_rsa
    comment: "SReview on {{ inventory_hostname }}"
    owner: sreview
    group: sreview
    mode: 0600
  register: sreview_ssh_key
  when: "'cloud-encoders' in group_names"

- name: install the SSH key onto the storage server
  ansible.posix.authorized_key:
    key: "{{ sreview_ssh_key.public_key }}"
    user: sreview
  delegate_to: "{{ item }}"
  loop: "{{ groups['encoder-storage'] }}"
  when: "'cloud-encoders' in group_names"

- name: install sshfs
  when: "'cloud-encoders' in group_names"
  ansible.builtin.apt:
    package: sshfs
    state: present

- name: sshfs the directories
  when: "'cloud-encoders' in group_names"
  ansible.builtin.command:
    cmd: sshfs sreview@reviewstorage.video.fosdem.org:{{ item.path }} {{ item.path }}
    creates: "{{ item.path }}/{{ item.file }}"
  with_items:
    - path: /var/lib/sreview
      file: script-output
    - path: /srv/sreview/storage
      file: video
    - path: /srv/sreview/assets
      file: announce.ep
    - path: /srv/sreview/output
      file: "{{ fosdem_year }}"

- name: sshfs the storage directory
  when: "'cloud-encoders' in group_names"
  ansible.builtin.command:
    cmd: sshfs sreview@reviewstorage.video.fosdem.org:/srv/sreview/storage /srv/sreview/storage
    creates: /srv/sreview/storage/video

- name: sshfs the assets directory
  when: "'cloud-encoders' in group_names"
  ansible.builtin.command:

- name: install the announcement email template
  copy:
    src: announce.ep
    dest: /srv/sreview/assets/announce.ep

- name: install the opening credits
  copy:
    src: open.svg
    dest: /srv/sreview/assets/open.svg

- name: install the closing credits
  copy:
    src: close.png
    dest: /srv/sreview/assets/close.png

- name: install the apology tmeplate
  copy:
    src: apology-2026.svg
    dest: /srv/sreview/assets/apology-2026.svg

- name: install the opening credits
  copy:
    src: opening-2026.svg
    dest: /srv/sreview/assets/opening-2026.svg

- name: install the closing credits
  copy:
    src: closing-2026.png
    dest: /srv/sreview/assets/closing-2026.png

- name: install the apology tmeplate
  copy:
    src: sorry.svg
    dest: /srv/sreview/assets/sorry.svg

- name: install the notification email template
  copy:
    src: notify-email.ep
    dest: /srv/sreview/assets/notify-email.ep

- name: Ensure the font directory exists
  file:
    name: /var/lib/sreview/.local/share/fonts
    state: directory
    owner: sreview
    group: sreview
  when: "{{ sreview.fonts is defined }}"

- name: install the fonts
  copy:
    src: "fonts/{{ item }}"
    dest: /var/lib/sreview/.local/share/fonts/{{ item }}
  loop: "{{ sreview.fonts }}"
  when: "{{ sreview.fonts is defined }}"
