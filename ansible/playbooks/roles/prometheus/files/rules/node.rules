instance_cpu:node_cpu_not_idle:rate1m = sum by (instance,cpu) keep_common (rate(node_cpu{mode!="idle"}[1m]))
instance_mode:node_cpu_not_idle:rate1m = sum by (instance,mode) keep_common (rate(node_cpu{mode!="idle"}[1m]))


ALERT NodeDown
  IF up{job="node"} == 0
  FOR 5m
  ANNOTATIONS {
    summary = "Node is down",
    description = "The node {{$labels.instance}} has been down for 5 min."
  }

ALERT SoundLow
  IF avg_over_time(ebu_r128[30s]) < -20 and on (stream) sreview_roomstate == 1
  FOR 2m
  LABELS {
    severity="critical"
  }
  ANNOTATIONS {
    summary = "Stream {{$labels.stream}} sound level low -20",
    description = "https://grafana.n.fosdem.net/dashboard/db/video-audio"
  }

ALERT SoundCritical
  IF avg_over_time(ebu_r128[30s]) < -50 and on (stream) sreview_roomstate == 1
  FOR 2m
  LABELS {
    severity="critical"
  }
  ANNOTATIONS {
    summary = "Stream {{$labels.stream}} sound level CRITICAL below -50",
    description = "https://grafana.n.fosdem.net/dashboard/db/video-audio"
  }

ALERT DiskFull
  IF node_filesystem_avail{fstype=~"(ext.|vfat|xfs)"} / node_filesystem_size{fstype=~"(ext.|vfat|xfs)"} * 100 < 5
  FOR 2m
  LABELS {
    severity="critical"
  }
  ANNOTATIONS {
    summary = "Disk has less than 5% free space",
    description = "https://grafana.n.fosdem.net/dashboard/db/video-audio"
  }

ALERT DiskWillFillIn4Hours
  IF predict_linear(node_filesystem_free[1h], 4*3600) < 0
  FOR 5m
  LABELS {
    severity="critical"
  }
  ANNOTATIONS {
    summary = "Disk will be full in 4 hours or less",
    description = "https://grafana.n.fosdem.net/dashboard/db/node"
  }
