#! /bin/bash

b64_error='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'

while true; do
	# Timeout set to 10000 ms
	ffmpeg -i {{ bmd_streamer_destination }}?timeout=10000 -vf scale=160:-1 -qscale:v 20 -vframes 1 -y /mnt/ssd/statuspage/screenshot.jpg 2>> /dev/null
	if [ $? -ne 0 ]; then
		b64=$b64_error
	else
		b64=$(base64 -w0 /mnt/ssd/statuspage/screenshot.jpg)
	fi
	uptime=$(uptime)
	ip=$(ip addr show dev eth0|grep 'inet '|cut -d' ' -f6)
	hostname=$(hostname | cut -d'.' -f1)
	uptime=$(uptime | cut -d ',' -f1)
	loadaverage=$(uptime | sed -e 's/.*load\ average\:\ //')
	sed -e "s/%%uptime%%/$uptime/g" -e "s/%%loadaverage%%/$loadaverage/g" -e "s;%%base64_image%%;$b64;g" -e "s/%%hostname%%/$hostname/g" -e "s?%%ip_address%%?$ip?g" /mnt/ssd/statuspage/template.html > /tmp/output.html
	mv /tmp/output.html /mnt/ssd/statuspage/output.html
	sleep 2s
done
